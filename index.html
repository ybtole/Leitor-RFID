<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitoramento RFID - Painel de Controle</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Pequeno ajuste para as tags de bloco no histÃ³rico */
        .tag-bloco {
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .dark-theme .tag-bloco {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body class="light-theme mode-admin">

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>HistÃ³rico</h2>
            <button onclick="toggleSidebar()" class="close-btn">&times;</button>
        </div>
        <div id="lista-historico" class="sidebar-content"></div>
    </div>

    <div class="controles-topo">
        <button id="btn-hist" onclick="toggleSidebar()" class="btn-acao btn-admin-only">â˜° HistÃ³rico</button>
        <button onclick="toggleTheme()" class="btn-acao" id="theme-btn">ðŸŒ™ Tema Escuro</button>
        <button onclick="toggleView()" class="btn-acao btn-view" id="view-btn">ðŸ‘¤ UsuÃ¡rio</button>
        
        <select id="filtro-bloco" class="btn-admin-only select-bloco" onchange="renderizarTudo()">
            <option value="TODOS">Todos os Blocos</option>
            <option value="BLOCO 1">Bloco 1</option>
            <option value="BLOCO 2">Bloco 2</option>
            <option value="BLOCO A">Bloco A</option>
            <option value="BLOCO D">Bloco D</option>
        </select>
    </div>

    <div class="container">
        <header id="cabecalho-principal">
            <h1 id="titulo-pagina">Painel Administrativo</h1>
            <p id="subtitulo-pagina">Gerenciamento em tempo real</p>
        </header>
        <div id="grid-principal"></div>
    </div>

    <script>
        const socket = io({ reconnection: true });
        let todosOsDados = [];
        let scrollInterval = null;
        let inactivityTimeout = null;
        let clockInterval = null;
        let temperaturaAtual = "--Â°C";
        let cidadeAtual = "Localizando...";

        // --- LÃ“GICA PARA FECHAR SIDEBAR AO CLICAR FORA ---
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const btnHist = document.getElementById('btn-hist');
            
            // Verifica se a sidebar estÃ¡ aberta
            if (sidebar.classList.contains('open')) {
                // Se o clique NÃƒO foi dentro da sidebar E NÃƒO foi no botÃ£o de abrir
                if (!sidebar.contains(event.target) && !btnHist.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });

        function toggleSidebar() { 
            document.getElementById("sidebar").classList.toggle("open"); 
        }

        async function buscarClima() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    try {
                        const resClima = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const dataClima = await resClima.json();
                        temperaturaAtual = `${Math.round(dataClima.current_weather.temperature)}Â°C`;
                        const resGeo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const dataGeo = await resGeo.json();
                        cidadeAtual = dataGeo.address.city || dataGeo.address.town || "Localidade";
                        atualizarRelogio(); 
                    } catch (e) { temperaturaAtual = "Erro"; }
                });
            }
        }

        function atualizarRelogio() {
            const titulo = document.getElementById('titulo-pagina');
            if (!document.body.classList.contains('mode-user')) return;
            const agora = new Date();
            const isInverted = document.body.classList.contains('dark-theme') ? "invert(1)" : "invert(0.4)";
            titulo.style.display = "flex";
            titulo.style.alignItems = "center";
            titulo.style.justifyContent = "center";
            titulo.style.gap = "12px";
            titulo.innerHTML = `
                ${agora.toLocaleDateString('pt-BR')} â€” ${agora.toLocaleTimeString('pt-BR')} â€” 
                <span style="display: flex; align-items: center;">
                    <img src="https://cdn-icons-png.flaticon.com/128/2932/2932445.png" style="width: 24px; height: 24px; filter: ${isInverted}; margin-right: 10px;">
                    ${temperaturaAtual} em ${cidadeAtual}
                </span>`;
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme');
            const isDark = document.body.classList.contains('dark-theme');
            document.getElementById('theme-btn').innerText = isDark ? "â˜€ï¸ Tema Claro" : "ðŸŒ™ Tema Escuro";
            if (document.body.classList.contains('mode-user')) atualizarRelogio();
        }

        function toggleView() {
            const body = document.body;
            const btn = document.getElementById('view-btn');
            const subtitulo = document.getElementById('subtitulo-pagina');
            if (body.classList.contains('mode-admin')) {
                body.classList.replace('mode-admin', 'mode-user');
                btn.innerText = "ðŸ› ï¸ Admin";
                subtitulo.style.display = 'none';
                buscarClima();
                clockInterval = setInterval(atualizarRelogio, 1000);
                resetInactivityTimer();
            } else {
                body.classList.replace('mode-user', 'mode-admin');
                btn.innerText = "ðŸ‘¤ UsuÃ¡rio";
                subtitulo.style.display = 'block';
                clearInterval(clockInterval);
                document.getElementById('titulo-pagina').innerHTML = "Painel Administrativo";
                stopAutoScroll();
            }
            renderizarTudo();
        }

        function startAutoScroll() {
            if (scrollInterval) return;
            scrollInterval = setInterval(() => {
                const scrollPos = window.pageYOffset || document.documentElement.scrollTop;
                const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
                if (scrollPos >= totalHeight - 5) {
                    stopAutoScroll();
                    window.scrollTo({ top: 0, behavior: 'instant' });
                    setTimeout(() => { if(document.body.classList.contains('mode-user')) resetInactivityTimer(); }, 1500);
                } else { window.scrollBy(0, 1); }
            }, 30);
        }

        function stopAutoScroll() { clearInterval(scrollInterval); scrollInterval = null; }

        function resetInactivityTimer() {
            stopAutoScroll();
            clearTimeout(inactivityTimeout);
            if (document.body.classList.contains('mode-user')) {
                inactivityTimeout = setTimeout(startAutoScroll, 3000);
            }
        }

        window.addEventListener('mousemove', resetInactivityTimer);
        window.addEventListener('keydown', resetInactivityTimer);

        // IMAGENS
       function renderizarTudo() {
            const container = document.getElementById('grid-principal');
            const isUser = document.body.classList.contains('mode-user');
            container.innerHTML = "";

            if (isUser) {
                const grupos = {};
                todosOsDados.forEach(d => {
                    if (!grupos[d.bloco]) grupos[d.bloco] = [];
                    grupos[d.bloco].push(d);
                });

                Object.keys(grupos).sort().forEach(bloco => {
                    const secao = document.createElement('div');
                    secao.className = 'secao-bloco';
                    secao.innerHTML = `<h2 class="titulo-bloco-user">${bloco}</h2><div class="grid-user"></div>`;
                    const grid = secao.querySelector('.grid-user');
                    
                    grupos[bloco].forEach(data => {
                        // LÃ³gica de Imagem: Tenta local, se falhar gera um rosto aleatÃ³rio baseado no ID
                        const fotoLocal = `img/${data.id}.jpg`;
                        const fotoAleatoria = `https://i.pravatar.cc/150?u=${data.id}`;
                        
                        grid.innerHTML += `
                            <div class="card-user animar-entrada" style="display: flex; align-items: center; gap: 20px; padding: 20px; min-width: 320px;">
                                <img src="${fotoLocal}" 
                                     onerror="this.src='${fotoAleatoria}'" 
                                     style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #ddd; background: #eee;">
                                <div style="text-align: left;">
                                    <h3 style="margin:0; font-size: 1.3rem;">${data.nome}</h3>
                                    <p style="margin:5px 0 0 0; font-size: 1rem;">Sala: <strong>${data.sala}</strong></p>
                                </div>
                            </div>`;
                    });
                    container.appendChild(secao);
                });
            } else {
                const filtro = document.getElementById('filtro-bloco').value;
                const gridAdmin = document.createElement('div');
                gridAdmin.className = 'grid-admin';
                
                todosOsDados.forEach(data => {
                    if (filtro === "TODOS" || data.bloco === filtro) {
                        const fotoLocal = `img/${data.id}.jpg`;
                        const fotoAleatoria = `https://i.pravatar.cc/150?u=${data.id}`;

                        gridAdmin.innerHTML += `
                            <div class="card-admin animar-entrada" style="display: flex; flex-direction: column; gap: 12px; padding: 20px; min-height: 160px; min-width: 350px;">
                                <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#888;">
                                    <span>ID: ${data.id}</span>
                                    <span style="background:rgba(0,0,0,0.08); padding:3px 8px; border-radius:4px;">ðŸ•’ ${data.hora || '--:--'}</span>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 20px;">
                                    <img src="${fotoLocal}" 
                                         onerror="this.src='${fotoAleatoria}'" 
                                         style="width: 90px; height: 90px; border-radius: 12px; object-fit: cover; background: #eee; border: 1px solid #ddd;">
                                    
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 8px 0; font-size: 1.3rem;">${data.nome}</h3>
                                        <p style="margin: 4px 0; font-size: 1rem;"><strong>Sala:</strong> ${data.sala}</p>
                                        <p style="margin: 4px 0; font-size: 1rem;"><strong>Bloco:</strong> ${data.bloco}</p>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
                container.appendChild(gridAdmin);
            }
        }

        socket.on('atualizar-lista', (data) => {
            const index = todosOsDados.findIndex(d => d.id === data.id);
            if (index !== -1) { todosOsDados[index] = data; } 
            else { todosOsDados.push(data); }

            const item = document.createElement('div');
            item.className = 'hist-item animar-entrada';
            item.innerHTML = `<strong>${data.nome}</strong> movido para <span class="tag-bloco">${data.bloco}</span><br><small>${data.hora}</small>`;
            document.getElementById('lista-historico').prepend(item);
            renderizarTudo();
        });

        window.onload = () => { buscarClima(); renderizarTudo(); };
    </script>
</body>
</html>