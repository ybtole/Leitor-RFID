<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitoramento RFID - Painel de Controle</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* CABE√áALHO EM LINHA √öNICA */
        #titulo-pagina {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 15px !important;
            flex-wrap: nowrap !important;
            white-space: nowrap !important;
        }
        #titulo-pagina span { display: flex; align-items: center; gap: 8px; }

        /* HIST√ìRICO - HORA NO CANTO SUPERIOR DIREITO */
        .hist-item {
            position: relative; /* Necess√°rio para posicionar a hora */
            background: rgba(128,128,128,0.05);
            padding: 22px 15px 15px 15px; /* Mais espa√ßo no topo para a hora n√£o atropelar o texto */
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            font-size: 15px; /* Aumentado levemente para visibilidade */
            text-align: left;
            min-height: 50px;
        }

        .hist-time-badge {
            position: absolute;
            top: 8px;
            right: 10px;
            background: #e0e0e0;
            color: #555;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .dark-theme .hist-time-badge {
            background: #333;
            color: #bbb;
        }

        .seta-movimento { color: var(--accent); font-weight: bold; padding: 0 4px; }

        /* CARD USER ALINHADO √Ä ESQUERDA */
        .card-user { text-align: left !important; display: flex !important; align-items: center !important; }
    </style>
</head>
<body class="light-theme mode-admin">

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>Hist√≥rico</h2>
            <button onclick="toggleSidebar()" class="close-btn">&times;</button>
        </div>
        <div id="lista-historico" class="sidebar-content"></div>
    </div>

    <div class="controles-topo">
        <button id="btn-hist" onclick="toggleSidebar()" class="btn-acao btn-admin-only">‚ò∞ Hist√≥rico</button>
        <button onclick="toggleTheme()" class="btn-acao" id="theme-btn">üåô Tema Escuro</button>
        <button onclick="toggleView()" class="btn-acao btn-view" id="view-btn">üë§ Usu√°rio</button>
        
        <select id="filtro-bloco" class="btn-admin-only select-bloco" onchange="renderizarTudo()">
            <option value="TODOS">Todos os Blocos</option>
            <option value="1">Bloco 1</option>
            <option value="2">Bloco 2</option>
            <option value="A">Bloco A</option>
            <option value="D">Bloco D</option>
        </select>
    </div>

    <div class="container">
        <header id="cabecalho-principal">
            <h1 id="titulo-pagina">Painel Administrativo</h1>
            <p id="subtitulo-pagina">Gerenciamento em tempo real</p>
        </header>
        <div id="grid-principal"></div>
    </div>

    <script>
        const socket = io();
        let todosOsDados = []; 
        let temperaturaAtual = "--¬∞C";
        let cidadeAtual = "Localizando...";
        let clockInterval = null;

        // --- UNIFICA√á√ÉO E HIST√ìRICO ---
        socket.on('atualizar-lista', (data) => {
            if (Array.isArray(data)) {
                todosOsDados = [];
                data.forEach(item => atualizarStatusUnico(item));
            } else {
                atualizarStatusUnico(data);
            }
            renderizarTudo();
        });

        function atualizarStatusUnico(novoDado) {
            const index = todosOsDados.findIndex(d => d.nome.trim().toUpperCase() === novoDado.nome.trim().toUpperCase());
            let blocoAnterior = "-----";

            if (index !== -1) {
                blocoAnterior = todosOsDados[index].bloco;
                todosOsDados[index] = novoDado;
            } else {
                todosOsDados.push(novoDado);
            }
            
            // S√≥ gera hist√≥rico se houver mudan√ßa de local
            if (blocoAnterior !== novoDado.bloco) {
                const lista = document.getElementById('lista-historico');
                const item = document.createElement('div');
                item.className = 'hist-item animar-entrada';
                item.innerHTML = `
                    <span class="hist-time-badge">${novoDado.hora || '00:00'}</span>
                    <strong>${novoDado.nome}</strong><br>
                    <span style="font-size: 0.9em; opacity: 0.8;">
                        ${blocoAnterior} <span class="seta-movimento">‚Üí</span> ${novoDado.bloco}
                    </span>
                `;
                lista.prepend(item);
            }
        }

        // --- CLIQUE FORA PARA FECHAR SIDEBAR ---
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const btnHist = document.getElementById('btn-hist');
            if (sidebar.classList.contains('open')) {
                if (!sidebar.contains(event.target) && !btnHist.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });

        // --- CONTROLES DE INTERFACE ---
        function toggleSidebar() { 
            document.getElementById("sidebar").classList.toggle("open"); 
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-theme');
            body.classList.toggle('light-theme');
            
            const isDark = body.classList.contains('dark-theme');
            const btn = document.getElementById('theme-btn');
            // Altera √≠cone e nome conforme o estado atual
            btn.innerText = isDark ? "‚òÄÔ∏è Tema Claro" : "üåô Tema Escuro";
            
            if (body.classList.contains('mode-user')) atualizarRelogio();
        }

        function toggleView() {
            const body = document.body;
            const btn = document.getElementById('view-btn');
            
            if (body.classList.contains('mode-admin')) {
                body.classList.replace('mode-admin', 'mode-user');
                btn.innerText = "üõ†Ô∏è Admin"; // No modo usu√°rio, mostra op√ß√£o para Admin
                buscarClima();
                clockInterval = setInterval(atualizarRelogio, 1000);
            } else {
                body.classList.replace('mode-user', 'mode-admin');
                btn.innerText = "üë§ Usu√°rio"; // No modo admin, mostra op√ß√£o para Usu√°rio
                clearInterval(clockInterval);
                document.getElementById('titulo-pagina').innerHTML = "Painel Administrativo";
            }
            renderizarTudo();
        }

        // --- REL√ìGIO E RENDERIZA√á√ÉO ---
        function atualizarRelogio() {
            const titulo = document.getElementById('titulo-pagina');
            if (!document.body.classList.contains('mode-user')) return;
            const agora = new Date();
            const filter = document.body.classList.contains('dark-theme') ? "invert(1)" : "invert(0.4)";
            
            titulo.innerHTML = `
                <span>${agora.toLocaleDateString('pt-BR')} ‚Äî ${agora.toLocaleTimeString('pt-BR')}</span>
                <span>
                    ‚Äî <img src="https://cdn-icons-png.flaticon.com/128/2932/2932445.png" style="width: 24px; filter: ${filter};">
                    ${temperaturaAtual} em ${cidadeAtual}
                </span>`;
        }

        function renderizarTudo() {
            const container = document.getElementById('grid-principal');
            const isUser = document.body.classList.contains('mode-user');
            container.innerHTML = "";

            if (isUser) {
                const grupos = {};
                todosOsDados.forEach(d => {
                    const blocoID = d.bloco.toString().toUpperCase().replace("BLOCO", "").trim();
                    if (!grupos[blocoID]) grupos[blocoID] = [];
                    grupos[blocoID].push(d);
                });

                Object.keys(grupos).sort((a, b) => a.localeCompare(b, undefined, {numeric: true})).forEach(id => {
                    const secao = document.createElement('div');
                    secao.className = 'secao-bloco';
                    secao.innerHTML = `<h2 class="titulo-bloco-user">BLOCO ${id}</h2><div class="grid-user"></div>`;
                    const grid = secao.querySelector('.grid-user');
                    grupos[id].forEach(data => {
                        grid.innerHTML += `
                            <div class="card-user animar-entrada">
                                <img src="img/${data.id}.jpg" onerror="this.src='https://i.pravatar.cc/150?u=${data.id}'" style="width:75px; height:75px; border-radius:50%; object-fit:cover; border: 2px solid #ddd;">
                                <div>
                                    <h3 style="margin:0; font-size:1.2rem;">${data.nome}</h3>
                                    <p style="margin:5px 0 0 0;">Sala: <strong>${data.sala}</strong></p>
                                </div>
                            </div>`;
                    });
                    container.appendChild(secao);
                });
            } else {
                const filtro = document.getElementById('filtro-bloco').value.replace("BLOCO", "").trim();
                const gridAdmin = document.createElement('div');
                gridAdmin.className = 'grid-admin';
                todosOsDados.forEach(data => {
                    const blocoLimpo = data.bloco.toString().toUpperCase().replace("BLOCO", "").trim();
                    if (filtro === "TODOS" || blocoLimpo === filtro) {
                        gridAdmin.innerHTML += `
                            <div class="card-admin animar-entrada">
                                <div class="card-header-admin">
                                    <span>ID: ${data.id}</span>
                                    <span class="hora-badge">üïí ${data.hora}</span>
                                </div>
                                <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">
                                    <img src="img/${data.id}.jpg" onerror="this.src='https://i.pravatar.cc/150?u=${data.id}'" style="width:85px; height:85px; border-radius:10px; object-fit:cover;">
                                    <div>
                                        <h3 style="margin:0;">${data.nome}</h3>
                                        <p style="margin:5px 0;">Sala: ${data.sala}</p>
                                        <p style="margin:0;">Bloco: ${data.bloco}</p>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
                container.appendChild(gridAdmin);
            }
        }

        async function buscarClima() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const { latitude: lat, longitude: lon } = pos.coords;
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const d = await res.json();
                        temperaturaAtual = `${Math.round(d.current_weather.temperature)}¬∞C`;
                        const resG = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const dG = await resG.json();
                        cidadeAtual = dG.address.city || dG.address.town || "Localidade";
                        atualizarRelogio();
                    } catch (e) { console.log("Erro clima"); }
                });
            }
        }

        window.onload = () => { renderizarTudo(); };
    </script>
</body>
</html>