<!--
* * Copyright (c) 2026 [ybtole]. Todos os direitos reservados.
* √â estritamente proibida a reprodu√ß√£o, distribui√ß√£o ou revenda deste c√≥digo,
* total ou parcial, sem a autoriza√ß√£o pr√©via e por escrito do autor.
* Este software √© fornecido para fins [Ex: Acad√™micos/Pessoais].
*/
 -->

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitoramento RFID - Painel de Controle</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="light-theme mode-admin">

    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>Hist√≥rico</h2>
            <button onclick="toggleSidebar()" class="close-btn">&times;</button>
        </div>
        <div id="lista-historico" class="sidebar-content"></div>
    </div>

    <div class="controles-topo">
        <button id="btn-hist" onclick="toggleSidebar()" class="btn-acao btn-admin-only">‚ò∞ Hist√≥rico</button>
        <button onclick="toggleTheme()" class="btn-acao" id="theme-btn">üåô Tema Escuro</button>
        <button onclick="toggleView()" class="btn-acao btn-view" id="view-btn">üë§ Usu√°rio</button>
        
        <select id="filtro-bloco" class="btn-admin-only select-bloco" onchange="renderizarTudo()">
            <option value="TODOS">Todos os Blocos</option>
            <option value="1">Bloco 1</option>
            <option value="2">Bloco 2</option>
            <option value="A">Bloco A</option>
            <option value="D">Bloco D</option>
        </select>
    </div>

    <button onclick="limparPainel()" class="btn-limpar btn-admin-only">üóëÔ∏è Limpar Painel</button>

    <div class="container">
        <header id="cabecalho-principal">
            <h1 id="titulo-pagina">Painel Administrativo</h1>
            <p id="subtitulo-pagina">Gerenciamento em tempo real</p>
        </header>
        <div id="grid-principal"></div>
    </div>

    <script>
        const socket = io(); // Inicializa a conex√£o em tempo real com o servidor
        let todosOsDados = []; // Armazena a lista atualizada de professores
        let temperaturaAtual = "--¬∞C";
        let cidadeAtual = "Localizando...";
        let clockInterval = null;
        let scrollInterval;
        let mouseTimer;
        let isScrolling = true;
        let scrollSpeed = 1; // Velocidade da rolagem autom√°tica

        // Envia comando ao servidor para apagar todos os registros
        function limparPainel() {
            if(confirm("Deseja limpar todos os dados do servidor?")) {
                socket.emit('limpar-dados-servidor'); 
            }
        }

        // Fun√ß√£o respons√°vel pela rolagem autom√°tica na vis√£o de Usu√°rio (Kiosk)
        function iniciarAutoScroll() {
            if (scrollInterval) clearInterval(scrollInterval);
            
            scrollInterval = setInterval(() => {
                const isUserMode = document.body.classList.contains('mode-user');
                if (!isScrolling || !isUserMode) return;

                // Verifica se a p√°gina chegou ao fim
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 2) {
                    isScrolling = false; 
                    setTimeout(() => {
                        // Se ainda for modo usu√°rio, volta ao topo suavemente
                        if(document.body.classList.contains('mode-user')) {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                        setTimeout(() => { isScrolling = true; }, 1500);
                    }, 2000); // Pausa de 2 segundos no fim da p√°gina
                } else {
                    window.scrollBy(0, scrollSpeed); // Rola X pixels para baixo
                }
            }, 30);
        }

        // Para o scroll autom√°tico ao interagir com o mouse/teclado e retoma ap√≥s 2s
        function resetMouseTimer() {
            isScrolling = false;
            clearTimeout(mouseTimer);
            mouseTimer = setTimeout(() => {
                isScrolling = true;
            }, 2000);
        }

        // Listeners para detectar intera√ß√£o do usu√°rio
        window.addEventListener('mousemove', resetMouseTimer);
        window.addEventListener('touchstart', resetMouseTimer);
        window.addEventListener('wheel', resetMouseTimer);
        window.addEventListener('keydown', resetMouseTimer);

        iniciarAutoScroll();

        // Escuta o servidor: Sempre que houver mudan√ßa nos dados, este bloco roda
        socket.on('atualizar-lista', (data) => {
            todosOsDados = data.professores || [];
            const listaHist = document.getElementById('lista-historico');
            listaHist.innerHTML = "";
            
            // Renderiza o log de movimenta√ß√µes na barra lateral
            if (data.historico) {
                data.historico.slice().reverse().forEach(mov => {
                    const item = document.createElement('div');
                    item.className = 'hist-item animar-entrada';
                    item.innerHTML = `
                        <span class="hist-time-badge">${mov.hora}</span>
                        <strong>${mov.nome}</strong><br>
                        <span style="font-size: 0.9em; opacity: 0.8;">
                            ${mov.de} <span class="seta-movimento">‚Üí</span> ${mov.bloco}
                        </span>
                    `;
                    listaHist.appendChild(item);
                });
            }
            renderizarTudo(); // Redesenha os cards na tela principal
        });

        // Fun√ß√µes de controle da interface (Sidebar, Temas e Vis√£o Admin/User)
        function toggleSidebar() { document.getElementById("sidebar").classList.toggle("open"); }

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const btnHist = document.getElementById('btn-hist');
            if (sidebar.classList.contains('open')) {
                if (!sidebar.contains(event.target) && !btnHist.contains(event.target)) {
                    sidebar.classList.remove('open');
                }
            }
        });

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-theme');
            body.classList.toggle('light-theme');
            const isDark = body.classList.contains('dark-theme');
            document.getElementById('theme-btn').innerText = isDark ? "‚òÄÔ∏è Tema Claro" : "üåô Tema Escuro";
            if (body.classList.contains('mode-user')) atualizarRelogio();
        }

        function toggleView() {
            const body = document.body;
            const btn = document.getElementById('view-btn');
            if (body.classList.contains('mode-admin')) {
                body.classList.replace('mode-admin', 'mode-user');
                btn.innerText = "üõ†Ô∏è Admin";
                buscarClima();
                clockInterval = setInterval(atualizarRelogio, 1000);
            } else {
                body.classList.replace('mode-user', 'mode-admin');
                btn.innerText = "üë§ Usu√°rio";
                clearInterval(clockInterval);
                document.getElementById('titulo-pagina').innerHTML = "Painel Administrativo";
            }
            renderizarTudo();
        }

        // Atualiza a data, hora e clima no cabe√ßalho (apenas modo usu√°rio)
        function atualizarRelogio() {
            const titulo = document.getElementById('titulo-pagina');
            if (!document.body.classList.contains('mode-user')) return;
            const agora = new Date();
            const filter = document.body.classList.contains('dark-theme') ? "invert(1)" : "invert(0.4)";
            titulo.innerHTML = `
                <span>${agora.toLocaleDateString('pt-BR')} ‚Äî ${agora.toLocaleTimeString('pt-BR')}</span>
                <span>‚Äî <img src="https://cdn-icons-png.flaticon.com/128/2932/2932445.png" style="width: 24px; filter: ${filter};"> ${temperaturaAtual} em ${cidadeAtual}</span>`;
        }

        // Busca informa√ß√µes clim√°ticas via API p√∫blica baseada na geolocaliza√ß√£o
        async function buscarClima() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const { latitude: lat, longitude: lon } = pos.coords;
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                        const d = await res.json();
                        temperaturaAtual = `${Math.round(d.current_weather.temperature)}¬∞C`;
                        const resG = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const dG = await resG.json();
                        cidadeAtual = dG.address.city || dG.address.town || "Localidade";
                        atualizarRelogio();
                    } catch (e) {}
                });
            }
        }

        // FUN√á√ÉO PRINCIPAL: Desenha os cards na tela
        function renderizarTudo() {
            const container = document.getElementById('grid-principal');
            const isUser = document.body.classList.contains('mode-user');
            container.innerHTML = "";

            if (isUser) {
                // No modo usu√°rio, agrupa os professores por bloco
                const grupos = {};
                todosOsDados.forEach(d => {
                    const b = d.bloco.toString().toUpperCase().replace("BLOCO", "").trim();
                    if (!grupos[b]) grupos[b] = [];
                    grupos[b].push(d);
                });

                Object.keys(grupos).sort().forEach(id => {
                    const secao = document.createElement('div');
                    secao.className = 'secao-bloco';
                    secao.innerHTML = `<h2 class="titulo-bloco-user">BLOCO ${id}</h2><div class="grid-user"></div>`;
                    const grid = secao.querySelector('.grid-user');
                    grupos[id].forEach(data => {
                        grid.innerHTML += `<div class="card-user animar-entrada"><img src="img/${data.id}.jpg" onerror="this.src='https://i.pravatar.cc/150?u=${data.id}'" style="width:120px; height:120px; flex-shrink: 0; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;"><div><h3 style="margin:0;font-size:1.2rem;">${data.nome}</h3><p style="margin:5px 0 0 0;">Sala: <strong>${data.sala}</strong></p></div></div>`;
                    });
                    container.appendChild(secao);
                });
            } else {
                // No modo Admin, exibe todos os cards com op√ß√£o de filtro
                const filtro = document.getElementById('filtro-bloco').value.replace("BLOCO", "").trim();
                const gridAdmin = document.createElement('div');
                gridAdmin.className = 'grid-admin';
                todosOsDados.forEach(data => {
                    const blocoLimpo = data.bloco.toString().toUpperCase().replace("BLOCO", "").trim();
                    if (filtro === "TODOS" || blocoLimpo === filtro) {
                        gridAdmin.innerHTML += `<div class="card-admin animar-entrada"><div class="card-header-admin"><span>ID: ${data.id}</span><span class="hora-badge">üïí ${data.hora}</span></div><div style="display:flex;align-items:center;gap:15px;margin-top:10px;"><img src="img/${data.id}.jpg" onerror="this.src='https://i.pravatar.cc/150?u=${data.id}'" style="width:85px;height:85px;border-radius:10px;object-fit:cover;"><div><h3 style="margin:0;">${data.nome}</h3><p style="margin:5px 0;">Sala: ${data.sala}</p><p style="margin:0;">Bloco: ${data.bloco}</p></div></div></div>`;
                    }
                });
                container.appendChild(gridAdmin);
            }
        }
        window.onload = () => { renderizarTudo(); };
    </script>
</body>
</html>